pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
b={}
b.x=64
b.y=96
b.a=.25
b.v=0
b.w=0
b.s=128
b.push_back=0
b.bow_blocked=false
b.aft_blocked=false
b.stk_effect=0
b.stk_timeout=0
b.stk_state=0
p={}

t=0
target_hit=false

function get_bow(b)
	dx=2*cos(b.a)
	dy=2*sin(b.a)
	return b.x+dx,b.y+dy
end

function get_aft(b)
	dx=2*cos(b.a)
	dy=2*sin(b.a)
	return b.x-dx,b.y-dy
end

function draw_board(b)
	for pp in all(p) do
		pset(pp[1],pp[2],1)
	end
	fx,fy=get_bow(b)
	ax,ay=get_aft(b)
	local c=7
	if b.crash then c=8 end
	line(fx,fy,ax,ay,c)
end

function detect_colision(b)
	--bow colisions
	b.bow_blocked=false
	fx,fy=get_bow(b)
	if pget(fx,fy)==10 then
		target_hit=true
	elseif pget(fx,fy)!=12 then
		b.bow_blocked=true
		sfx(1)
		b.v=0
		b.w=0
		b.x,b.y=lx,ly
	end
	--aft colisions
	b.aft_blocked=false
	ax,ay=get_aft(b)
	if pget(ax,ay)!=12 then
		b.aft_blocked=true
		b.push_back=0
		b.x,b.y=lx,ly
	end
end

function move_forward(b)
	--forward velocity
	b.v-=0.025
	if b.v<0 then b.v=0 end
	b.push_back-=0.05
	if b.push_back<0 then b.push_back=0 end
	--turn
	b.a+=0.1*b.w
	--move
	lx,ly=b.x,b.y
	dx=(b.v-b.push_back)*cos(b.a)
	dy=(b.v-b.push_back)*sin(b.a)
	b.x+=0.25*dx
	b.y+=0.25*dy
	--colision
	detect_colision(b)
	--trace
	p[#p+1]={b.x,b.y}
end

function draw_map()
	map(0,0,0,0,16,16)
end

function resolve_movement()
	move_forward(b)
end

function _draw()
	cls()
	draw_map()
	resolve_movement()
	draw_board(b)
	print("stamina "..b.s,1,122)
	print("time "..t,64,122)
	print("stroke "..b.stk_state.." "..b.stk_effect.." "..b.stk_timeout,1,1)
end

function reduce_stamina()
	b.s-=15
	if b.s<0 then b.s=0 end
end

function have_stamina()
	return b.s>0
end

function recharge_stamina()
	b.s+=2
	if b.s>100 then b.s=100 end
end

function handle_strokes(b)
	--idle
	if b.stk_state==0 then
		b.w=0.0
		if btnp(4) or btnp(5) then
			sfx(0)
			b.stk_state=1
			b.stk_effect=15
			b.stk_timeout=10
			if btnp(4) then b.stk_w=-.1
			else b.stk_w=.1
			end
		end
	elseif b.stk_state==1 then
		b.w=0
		b.v+=0.1
		if btn(4) or btn(5) then
			b.stk_effect-=1
			if b.stk_effect<=0 then
				b.stk_state=2
			end
		else
			b.stk_state=2
			b.stk_effect=0
		end
		if b.stk_effect>0 then
			b.w=b.stk_w
		end
	elseif b.stk_state==2 then
		b.stk_timeout-=1
		if b.stk_timeout<=0 and not (btn(4) or btn(5)) then
			b.stk_state=0
		end
	end
end

function _update()
	--recover stamina over time
	recharge_stamina()
	handle_strokes(b)
	--revert
	if btnp(3) then
		reduce_stamina()
		if have_stamina() then
			b.push_back=1
		end
	end
	--timer
	if not target_hit then
		t+=1
	end
end

__gfx__
00000000bbbbbbbbbbbbbbbbbbbbbbbbcccccccc00000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbbbbbbbbbbbbbbbbbbcccccccc00000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000
00700700bbbbb44b4b44b44bb4bbbbbbccccc44c00000000c4cccccc000000000000000000000000000000000000000000000000000000000000000000000000
00077000bbbb4c4444cc4c444c44bbbbcccc4b44000000004b44cccc000000000000000000000000000000000000000000000000000000000000000000000000
00077000bbb4cccccccccccccccc4bbbccc4bbbb00000000bbbb4ccc000000000000000000000000000000000000000000000000000000000000000000000000
00700700bbb4ccccccccccccccccc4bbccc4bbbb00000000bbbbb4cc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb4ccccccccccccccccc44bbcc4bbbbb00000000bbbb44cc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4cccccccccccccccc4bbbccc4bbbb00000000bbbb4ccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4cccccccccccccccc44bbccccccccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb44cccccccccccccccc4bbbccccccccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb4cccccccccccccccccc4bbcccaacccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4ccccccccccccccccc4bbccaaaaccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb4ccccccccccccccccc4bbbccaaaaccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb4cccccccccccccccccc4bbcccaacccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4cccccccccccccccc44bbccccccccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb44cccccccccccccccc4bbbccccccccbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4cccccccccccccccc4bbbccc4bbbb00000000bbbb4ccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb44ccccccccccccccccc4bbcc44bbbb00000000bbbbb4cc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb4ccccccccccccccccc4bbbcc4bbbbb00000000bbbb4ccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4cccccccccccccccc4bbbccc4bbbb00000000bbbb4ccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbb44c444c4cc4444c4bbbbcccc44b40000000044b4cccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbb4bb44b44b4b44bbbbbcccccc4c00000000c44ccccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbbbbbbbbbbbbbbbbbbcccccccc00000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbbbbbbbbbbbbbbbbbbcccccccc00000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1515151515151515151515151515151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515151515151515010202031515151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515010202020203111212131515151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515111212121213111212131515151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515111212121213210612131515151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102261212121224022612240315151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1112121204061212121212122402020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2106121213111212042206121212121300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1511121213210612131511121212042300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1511121224022612130126121212131500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1511121212121212131112121212131500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1511121212121212131112121212131500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1511121212121212131112121212131500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1521220612121212131114121212131500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515152122222222232122222222231500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515151515151515151515151515151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000300001f61020610206102162022620226202362023620236202363023630226302263021630206301f6301e6201d6201c6201b6201a6101a61018610186101761016610166100160000000000000000000000
010400000452003541025210151100511000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
