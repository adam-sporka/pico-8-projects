pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--pretty sqrs in pretty sqrs
--@adam_sporka

--squares entities--
sqrs={}
function new_sqr(x,y,c)
	sqr={}
	sqr.x=x	sqr.y=y	sqr.c=c
	return sqr
end
function cpy_sqr(sqr)
	out={}
	out.x=sqr.x	out.y=sqr.y	out.c=sqr.c
	return out
end
function find_sqr(x,y)
	for s in all(sqrs) do
		if s.x==x and s.y==y then
			return s
		end
	end
	return nil
end
function get_belong(x,y)
	for s in all(sqrs) do
		if abs(x-s.x)<s.c/2
			and abs(y-s.y)<s.c/2 then
			return s
		end
	end
	return nil
end
function scan(x,y)
	min_size=128
	for a=4,128,8 do
		p=get_belong(x,a)
		if p!=nil then
			if p.c<min_size then
				min_size=p.c
			end
		end
		q=get_belong(a,y)
		if q!=nil then
			if q.c<min_size then
				min_size=q.c
			end
		end
	end
	return min_size
end
function get_sqr(sqr)
	for s in all(sqrs) do
		if s.x==sqr.x and s.y==sqr.y and s.c==sqr.c then
			return s
		end
	end
	return nil
end
function exists(sqr,dx,dy)
	a=cpy_sqr(sqr)
	a.x+=dx*a.c
	a.y+=dy*a.c
	return get_sqr(a)
end
function add_sqr(sqr)
	add(sqrs,sqr)
end
function del_sqr(sqr)
	del(sqrs,sqr)
end
function spl_sqr(x,y)
	sqr=find_sqr(x,y)
	if sqr==nil then return end
	a=cpy_sqr(sqr) a.c/=2 a.x-=sqr.c/4 a.y-=sqr.c/4
	b=cpy_sqr(sqr) b.c/=2 b.x+=sqr.c/4 b.y-=sqr.c/4
	c=cpy_sqr(sqr) c.c/=2 c.x-=sqr.c/4 c.y+=sqr.c/4
	d=cpy_sqr(sqr) d.c/=2 d.x+=sqr.c/4 d.y+=sqr.c/4
	del_sqr(sqr)
	add_sqr(a)
	add_sqr(b)
	add_sqr(c)
	add_sqr(d)
end
function mrg_sqrs(x,y,c)
	a1=find_sqr(x-c/4,y-c/4,c/2)
	a2=find_sqr(x+c/4,y-c/4,c/2)
	a3=find_sqr(x-c/4,y+c/4,c/2)
	a4=find_sqr(x+c/4,y+c/4,c/2)
	if a1 and a2 and a3 and a4 then
		e=new_sqr(x,y,c)
		add_sqr(e)
		del_sqr(a1)
		del_sqr(a2)
		del_sqr(a3)
		del_sqr(a4)
	else
	end
end

-->8
--squares drawing--
color={}
color[8]=1
color[16]=2
color[32]=3
color[64]=4
color[128]=5

draw_mode=0
draw_ipts_enabled=true

function drw_sqr(sqr)
	x1=sqr.x-sqr.c/2
	x2=sqr.x+sqr.c/2-1
	y1=sqr.y-sqr.c/2
	y2=sqr.y+sqr.c/2-1
	if draw_mode==0 then
		clr=sqr.color or color[sqr.c]
		rectfill(x1,y1,x2,y2,clr)
	elseif draw_mode==1 then
		rect(x1,y1,x2,y2,7)
	elseif draw_mode==2 then
		rectfill(x1,y1,x2,y2,5)
		line(x1,y1,x2-1,y1,6)
		line(x1,y1,x1,y2-1,6)
		line(x1+1,y2,x2,y2,0)
		line(x2,y1+1,x2,y2,0)
	end
end

function draw_squares()
	for s in all(sqrs) do
		drw_sqr(s)
	end
end

function draw_ipts()
	for i in all(ipts) do
		x1=i.x-1 x2=i.x y1=i.y-1 y2=i.y
		if i.verb=="spl" then
			spr(2,x1-3,y1-3)
		elseif i.verb=="mrg" then
			rectfill(x1,y1,x2,y2,7)
		end
	end
end

function _draw()
	cls()
	draw_squares()
	if draw_ipts_enabled then
		draw_ipts()
	end
	spr(1,mx,my)
end
-->8
--ipts entities--
ipts={}
function collect_ipts()
	ipts={}
	for s in all(sqrs) do
		if s.c>8 then
			ipt={}
			ipt.verb="spl"
			ipt.x=s.x
			ipt.y=s.y
			add(ipts,ipt)
		end
	end
	for s in all(sqrs) do
		l=exists(s,-1,0)
		c=exists(s,-1,-1)
		a=exists(s,0,-1)
		if l and c and a then
			ipt={}
			ipt.verb="mrg"
			ipt.x=s.x-s.c/2
			ipt.y=s.y-s.c/2
			ipt.c=s.c*2
			add(ipts,ipt)
		end
	end
end

function do_ipt(ipt)
	if ipt.verb=="spl" then
		spl_sqr(ipt.x,ipt.y)
	elseif ipt.verb=="del" then
		sqr=find_sqr(ipt.x,ipt.y)
		del_sqr(sqr)
	elseif ipt.verb=="mrg" then
		mrg_sqrs(ipt.x,ipt.y,ipt.c)
	end
end

function find_ipt(x,y)
	for i in all(ipts) do
		if abs(i.x-x)+abs(i.y-y)<3 then
			return i
		end
	end
	return nil
end
-->8
--update--
mx=0
my=0
mb=false

function handle_ipts()
	ipt=find_ipt(mx,my)
	if ipt != nil then
		do_ipt(ipt)
	end
end

function on_user_clicked()
	handle_ipts()
	collect_ipts()
end

function _update()
 if peek(0x5f2d)>0 then
		mx=stat(32)
		my=stat(33)
	end
	if stat(34)>0 then
		if not mb then
			on_user_clicked()
			mb=true
		end
	else
		mb=false
	end
	if (btn(0)) mx-=1
	if (btn(1)) mx+=1
	if (btn(2)) my-=1
	if (btn(3)) my+=1
	if btnp(4) then
		on_user_clicked()
	end
	if btnp(5) then
		poke(0x5f2d,1-peek(0x5f2d))
	end
end
-->8
--init--
function initialize()
	add_sqr(new_sqr(64,64,128))
end

function _init()
	initialize()
	collect_ipts()
end
__gfx__
00000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666000000060060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000666600000000000000066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000666000000000000000066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700606600000060060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222226226222222222222622622222222222262262222224444444444444444444444444444444444444444444444444444444444444444
11111117711111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111117711111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222226226222222222222622622222222222262262222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111112222222222222222222222222222222222222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222262262222222222226226222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222262262222222222226226222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
22222222222222222222222222222222333333333333336336333333333333334444444444444444444444444444446446444444444444444444444444444444
22222222222222222222222222222222333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333336336333333333333334444444444444444444444444444446446444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111117711111177111111771111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111117711111177111111771111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111117711111177111111771111111333333333333333333333333333333334444444444444444444444444444444444444444444444444444444444444444
11111117711111177111111771111111111111111111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111111111111111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111111111111111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111111111111111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111111111111111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111111111111111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111111111111111111122222262262222224444444444444444444444444444444444444444444444444444444444444444
11111111111111111111111111111111111111111111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111122222262262222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222262262222221111111122222262262222221111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111122222222222222224444444444444444444444444444444444444444444444444444444444444444
22222222222222221111111122222222222222221111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
22222262262222221111111122222262262222221111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
22222222222222221111111122222222222222221111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
22222222222222221111111122222222222222221111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
22222222222222221111111122222222222222221111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
22222222222222221111111122222222222222221111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
22222222222222221111111122222222222222221111111111111111111111112222226226222222333333333333333333333333333333332222226226222222
22222222222222221111111122222222222222221111111771111117711111112222222222222222333333333333333333333333333333332222222222222222
11111111111111111111111111111111111111111111111771111117711111112222222222222222333333333333333333333333333333332222222222222222
11111111111111111111111111111111111111111111111111111111111111112222226226222222333333333333333333333333333333332222226226222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222333333333333336336333333333333332222222222222222
11111117711111111111111111111111111111111111111111111117711111112222222222222222333333333333333333333333333333332222222222222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333336336333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222226226222222333333333333333333333333333333332222226226222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222333333333333333333333333333333332222222222222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222226226222222333333333333333333333333333333332222226226222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111111111111113333333333333363363333333333333311111111111111112222222222222222333333333333333333333333333333332222222222222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222333333333333333333333333333333332222222222222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222111111111111111111111111111111112222222222222222
11111111111111113333333333333363363333333333333311111111111111112222222222222222111111111111111111111111111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111111111111111111111111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111111111111111111111111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111111111111111111111111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111111111111111111111111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222226226222222111111111111111111111111111111112222226226222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222111111111111111111111111111111112222222222222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222111111112222222222222222111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222226226222222111111112222222222222222111111112222226226222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111113333333333333333333333333333333311111111111111112222222222222222111111112222226226222222111111112222222222222222
11111117711111113333333333333333333333333333333311111117711111112222222222222222111111112222222222222222111111112222222222222222
11111117711111111111111111111111111111111111111111111117711111112222222222222222111111112222222222222222111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111112222226226222222111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111112222222222222222111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222226226222222111111112222222222222222111111112222226226222222
11111117711111177111111771111117711111177111111771111117711111112222222222222222111111112222222222222222111111112222222222222222
11111117711111177111111771111117711111177111111771111117711111112222222222222222111111111111111111111111111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222226226222222111111111111111111111111111111112222226226222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111611111111111111111111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111661111111111111111111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111666111111111111111111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111666611111111111111111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111666111111111111111111111112222222222222222
11111111111111111111111111111111111111111111111111111111111111112222222222222222111111616611111111111111111111112222222222222222

__sfx__
000800001305013040120100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001505015040140100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001705017040160100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001905019040180100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001b0501b0401a0100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001a0101b0401b0500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001801019040190500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001601017040170500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001401015040150500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001201013040130501300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
